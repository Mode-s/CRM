# FMT CRM 開発ログ

> **プロジェクト:** FMT CRM - エネパル投入管理システム
> **開始日:** 2026-02-12
> **最終更新:** 2026-02-12
> **Phase:** Phase 1（ローカル動作版）

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| フロントエンド | HTML5 / CSS3 / Vanilla JavaScript |
| データ永続化 | LocalStorage（Phase 2 で Firebase 移行予定） |
| フォント | Inter / Noto Sans JP（Google Fonts） |
| アイコン | Font Awesome 6 Free |
| スタイリング | カスタム CSS（CSS変数によるデザインシステム） |

---

## ファイル構成

```
FMT/
├── index.html                  # エントリポイント・スクリプト読み込み
├── css/
│   └── style.css               # デザインシステム（CSS変数・全コンポーネント）
├── data/
│   └── seed.js                 # 初期データ（デモ用サンプルデータ）
├── js/
│   ├── store.js                # データストア（LocalStorage CRUD・監査ログ連携）
│   ├── audit.js                # 監査ログモジュール
│   ├── auth.js                 # 認証（sessionStorage セッション管理）
│   ├── router.js               # ハッシュベースルーター（ロールベースアクセス制御）
│   ├── app.js                  # 初期化・ルート定義
│   ├── components/
│   │   ├── header.js           # ヘッダー（ロール別ナビゲーション）
│   │   ├── modal.js            # モーダルダイアログ（confirm / alert / image preview）
│   │   └── notification.js     # アプリ内通知バッジ
│   └── views/
│       ├── login.js            # ログイン画面（クイックログインボタン付き）
│       ├── salesHome.js        # 営業ホーム（マイ依頼一覧・行クリック詳細）
│       ├── newRequest.js       # 新規投入依頼フォーム（地点自動作成対応）
│       ├── addSite.js          # 地点追加画面
│       ├── deficiency.js       # 不備修正画面
│       ├── operatorHome.js     # 投入担当ホーム（全案件一覧・行クリック遷移）
│       ├── caseDetail.js       # 案件詳細（ステータス変更・地点情報入力・法人編集）
│       ├── acquiredList.js     # 獲得案件一覧（法人/地点/電気/ガス別）
│       ├── agencyManage.js     # 代理店管理（管理者専用）
│       ├── userManage.js       # ユーザー管理（管理者専用）
│       ├── agencyStats.js      # 代理店別KPIサマリ
│       ├── auditLog.js         # 監査ログ閲覧（管理者専用）
│       └── adminDashboard.js   # 管理者ダッシュボード
├── CRM要件定義書.md             # 要件定義書（v1.1）
├── 開発ログ.md                  # このファイル
└── 実装ルール.md                # 次回実装時の参照ルール
```

---

## 実装履歴

### 2026-02-12: Phase 1 初期実装

#### 1. 要件定義・設計（完了）
- TONY-PageSource（エネパル管理画面5ページ）を分析
- CRM要件定義書 v1.1 を作成
- Q1〜Q12 の確認事項を全て決定
- 実装計画書を作成・レビュー

#### 2. 基盤実装（完了）- 全24ファイル作成
- **デザインシステム**: CSS変数、カラーパレット（Primary Blue系）、レスポンシブ対応
- **データストア**: 8テーブル（agencies / users / requests / corporations / sites / images / comments / auditLogs）
- **認証**: login_id + password でのログイン、sessionStorage でセッション管理
- **ルーター**: ハッシュベース、ロール別アクセス制御（sales / operator / admin）
- **共通コンポーネント**: ヘッダー（ロール別ナビ）、モーダル、通知バッジ、トースト

#### 3. 画面実装（完了）
- **営業画面**: ログイン / マイ依頼一覧 / 新規投入依頼 / 地点追加 / 不備修正
- **投入担当画面**: 投入案件一覧 / 案件詳細（ステータス変更・地点入力）
- **管理者画面**: ダッシュボード / 代理店管理 / ユーザー管理 / 監査ログ
- **共通画面**: 獲得案件一覧 / 代理店KPIサマリ

### 2026-02-12: フィードバック対応（6件）

#### 修正内容

| # | フィードバック | 対応 | 対象ファイル |
|---|--------------|------|-------------|
| 1 | 絵文字→アイコン | Font Awesome アイコンに統一 | 全ビューファイル |
| 2 | ステータス変更不可 | 対応中/投入済/不備/キャンセルの全方向変更ボタン追加 | `caseDetail.js` |
| 3 | 獲得数管理 | 法人別・地点別・電気/ガス別の集計表示 | `acquiredList.js` |
| 4 | 地点情報入力なし | 全項目対応の包括的入力フォーム（5セクション）を追加 | `caseDetail.js` |
| 5 | カードクリック不可 | テーブル行全体がクリッカブルに（詳細遷移） | `operatorHome.js` / `salesHome.js` |
| 6 | デザイン統一 | 既存デザインシステムに準拠 | 全ファイル |

### 2026-02-12: 地点自動作成

- **修正**: 営業が新規依頼で入力した「地点数」に応じて、依頼作成時に空の地点レコードを自動生成
- **対象**: `newRequest.js` の `handleSubmit` 関数
- **効果**: 投入担当者が手動で「地点追加」する必要がなくなった

### 2026-02-12: Seedデータ拡充

- **修正**: 法人3社・依頼3件（完了2件+対応中1件）・地点6件のサンプルデータ追加
- **対象**: `data/seed.js`
- **効果**: 獲得案件画面に初期データが表示されるようになった

---

## テストアカウント

| ロール | ログインID | パスワード | 所属代理店 |
|--------|-----------|-----------|-----------|
| 管理者 | `admin` | `admin123` | なし（全権限） |
| 投入担当 | `operator` | `ope123` | なし（全代理店横断） |
| 営業A | `sales_a` | `sales123` | AAA代理店 |
| 営業B | `sales_b` | `sales123` | BBB代理店 |

---

## 画面ルーティング

| パス | 画面 | アクセス可能ロール |
|------|------|-------------------|
| `/login` | ログイン | 全ロール |
| `/my-requests` | マイ依頼一覧 | sales, admin |
| `/new-request` | 新規投入依頼 | sales, admin |
| `/add-site` | 地点追加 | sales, admin |
| `/deficiency` | 不備修正 | sales, admin |
| `/cases` | 投入案件一覧 | operator, admin |
| `/case/:id` | 案件詳細 | operator, admin |
| `/acquired` | 獲得案件一覧 | sales, operator, admin |
| `/agencies` | 代理店管理 | admin |
| `/users` | ユーザー管理 | admin |
| `/agency-stats` | 代理店KPIサマリ | operator, admin |
| `/audit-log` | 監査ログ | admin |
| `/dashboard` | 管理者ダッシュボード | admin |

---

## データテーブル構造

| テーブル名 | LocalStorageキー | 概要 |
|-----------|-----------------|------|
| agencies | `fmt_agencies` | 代理店マスタ |
| users | `fmt_users` | ユーザーマスタ |
| requests | `fmt_requests` | 投入依頼 |
| corporations | `fmt_corporations` | 法人・契約者情報 |
| sites | `fmt_sites` | 地点（供給地点）情報 |
| images | `fmt_images` | 明細画像（Base64） |
| comments | `fmt_comments` | コメント・不備理由 |
| auditLogs | `fmt_audit_logs` | 監査ログ |

---

## ステータスフロー

```
対応中 (inprogress) ←→ 不備 (deficiency)
    ↓                         ↑
投入済 (completed)            │
    ↓                         │
キャンセル (cancelled) ───────┘
```

- 全方向のステータス変更が可能（`caseDetail.js`）
- 地点を全て投入済にすると依頼も自動的に投入済に
- 不備差し戻し時はコメント（理由）必須

---

## 今後の予定（Phase 2）

- [ ] Firebase 移行（データ永続化・マルチユーザー）
- [ ] プッシュ通知
- [ ] 排他制御（同時編集防止）
- [ ] OCR 連携（明細画像の自動読み取り）
- [ ] キャリア管理画面 API 連携
- [ ] ユーザー招待・パスワードリセット
- [ ] 集計・CSVエクスポート
