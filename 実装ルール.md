# FMT CRM 実装ルール

> **目的:** 次回実装時にこのファイルを最初に読み込み、一貫性のある開発を行うためのルール集
> **最終更新:** 2026-02-12

---

## 1. 基本方針

- **日本語で回答する**こと
- 絵文字は使用禁止。**Font Awesome 6 Free** のアイコンを使用する
- デザインは現在のスタイルに必ず合わせる（`css/style.css` のデザインシステムに準拠）
- Phase 1 は HTML / CSS / Vanilla JavaScript + LocalStorage で構築。外部フレームワーク不使用
- **セキュリティ（Phase 1）**: 簡易的なハッシュ化（SHA-256など）を実装すること。平文保存は禁止。

---

## 2. デザインルール

### カラーパレット
- **Primary**: Blue系（`--primary-500: #3b82f6` を基準）
- **ステータス色**:
  - 不備: `--status-deficiency: #ef4444`（赤）
  - 対応中: `--status-inprogress: #f59e0b`（黄）
  - 投入済: `--status-completed: #10b981`（緑）
  - キャンセル: `--status-cancelled: #6b7280`（グレー）

### アイコン
- Font Awesome 6 Free を使用（CDN読み込み済み）
- 例: `<i class="fas fa-check-circle"></i>`
- 絵文字（🔥📊 等）は**絶対に使わない**

### コンポーネント
- CSS変数（`var(--xxx)`）を使ってスタイル適用
- カード: `.card` / `.card-header` / `.card-body`
- ボタン: `.btn` + `.btn-primary` / `.btn-secondary` / `.btn-danger` / `.btn-success` / `.btn-warning` / `.btn-ghost`
- テーブル: `.table-container` + `.data-table`
- 統計カード: `.stats-grid` + `.stat-card`
- アコーディオン: `.expandable-group` / `.expandable-header` / `.expandable-body`
- フォーム: `.form-section` / `.form-group` / `.form-row` / `.form-input` / `.form-select` / `.form-textarea`
- ステータスバッジ: `.status-badge` + `.status-deficiency` / `.status-inprogress` / `.status-completed` / `.status-cancelled`

### レイアウト
- ページ幅: `--content-max-width: 1280px`
- ヘッダー高さ: `--header-height: 64px`
- 角丸: `--border-radius: 8px` / `--border-radius-lg: 12px`

### インタラクション
- テーブル行はクリッカブル（`tr.clickable` + `onclick`）にして詳細遷移
- 「詳細」ボタン単体ではなく、**行全体クリック**で遷移する
- Lightなホバーエフェクトとtransitionをつける

---

## 3. コーディング規約

### モジュール構造
- 各画面は **IIFE（即時実行関数）** パターンで定義
  ```javascript
  const XxxView = (() => {
      function render(container, params) { ... }
      // private functions
      return { render, publicMethod1, publicMethod2 };
  })();
  ```

### データ操作
- `Store.create(table, data)` → レコード作成（id / created_at / updated_at 自動付与）
- `Store.update(table, id, updates)` → 部分更新
- `Store.getById(table, id)` → 単件取得
- `Store.getAll(table)` → 全件取得
- `Store.query(table, filterFn)` → フィルタ取得
- `Store.changeStatus(table, id, newStatus)` → ステータス変更（監査ログ自動記録）
- `Store.computeRequestStatus(requestId)` → 地点のステータスから依頼ステータスを自動計算

### 認証
- `Auth.currentUser()` → 現在のログインユーザー情報
- `Auth.getAgencyFilter()` → 営業担当の場合は`agency_id`、それ以外は`null`
- セッションは `sessionStorage` に保存
- **パスワード保存**: `Store.create` / `Store.update` 時に簡易ハッシュ化を行うこと

### ルーター
- `Router.navigate('/path')` → 画面遷移
- `Router.handleRoute()` → 現在の画面を再描画（データ更新後に使用）
- ルート定義: `Router.define('/path', ViewModule.render, ['sales', 'operator', 'admin'])`

### 通知
- `Toast.show('メッセージ', 'success' | 'error' | 'warning' | 'info')` → トースト通知
- `Modal.show(title, bodyHtml, footerHtml)` → モーダル表示
- `Modal.confirm(title, message, onConfirm, confirmLabel, btnClass)` → 確認ダイアログ
- `Modal.hide()` → モーダル閉じる

### ステータスバッジ（共通関数）
- `getStatusBadge(status)` → ステータスバッジHTMLを返すグローバル関数（`salesHome.js` 最下部で定義）

### 都道府県セレクト（共通関数）
- `getPrefectureOptions()` → 47都道府県の`<option>`タグを返すグローバル関数（`newRequest.js` 最下部で定義）

---

## 4. ファイル追加・変更時の注意

### 新しいビューを追加する場合
1. `js/views/` にファイル作成
2. `index.html` の `<script>` タグに追加（読み込み順に注意）
3. `js/app.js` の `defineRoutes()` にルート登録
4. `js/components/header.js` のナビゲーションに追加（ロール別）

### スクリプト読み込み順序（index.html）
```
1. store.js       ← 最初（他の全モジュールが依存）
2. audit.js       ← store の次
3. auth.js        ← store に依存
4. router.js      ← auth に依存
5. components/    ← router, auth に依存
6. views/         ← 全基盤に依存
7. seed.js        ← store に依存
8. app.js         ← 最後（全モジュール登録後に初期化）
```

### 新しいデータテーブルを追加する場合
1. `js/store.js` の `TABLES` オブジェクトにキー追加
2. `data/seed.js` に初期データ追加（必要な場合）

---

## 5. 業務フロー概要

```
営業担当 → 新規投入依頼 → [法人情報 + 明細画像 + 地点数]
    ↓                          ↓（地点数に応じて地点レコード自動生成）
投入担当 → 案件詳細 → 地点情報入力 → 投入済にする
    ↓ 不備の場合                    ↓
不備差し戻し（理由必須）→ 営業が修正  → 獲得案件一覧に自動反映
```

### 重要な仕様
- **1依頼 = 1法人** + N地点（地点数は営業が指定、自動生成）
- 投入担当は地点追加ボタンで**追加地点も作成可能**
- 不備差し戻し時は**コメント（理由）が必須**
- 営業は自分の代理店の案件のみ閲覧可能（データ隔離）
- 投入担当・管理者は全代理店を横断して閲覧可能

---

## 6. LocalStorage の注意

- `fmt_initialized` フラグが `true` の場合、seedデータは再生成されない
- データをリセットするには: `localStorage.clear()` 後にリロード
- 画像データはBase64でLocalStorageに保存（容量注意）
- QuotaExceededError 時はトースト通知で警告

---

## 7. 次回開発の進め方

1. **このファイル（実装ルール.md）を最初に読む**
2. `開発ログ.md` で現在の状態を確認
3. `CRM要件定義書.md` で未実装の要件を確認
4. 変更前に対象ファイルの現状を必ず確認する
5. 変更後は `開発ログ.md` に追記する
